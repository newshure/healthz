# =============================================================================
# 헬스체크 애플리케이션 설정 파일
# =============================================================================

# -----------------------------------------------------------------------------
# 애플리케이션 정보
# -----------------------------------------------------------------------------
application:
  name: healthcheck-app
  version: 1.0.0
  environment: production  # development, staging, production

# -----------------------------------------------------------------------------
# 서버 설정
# -----------------------------------------------------------------------------
server:
  # 리스닝 호스트 (0.0.0.0: 모든 인터페이스, localhost: 로컬만)
  host: 0.0.0.0
  
  # 리스닝 포트
  port: 8080
  
  # 워커 프로세스 수 (Gunicorn 사용 시, CPU 코어 수의 2-4배 권장)
  workers: 4
  
  # 워커 타임아웃 (초)
  timeout: 30

# -----------------------------------------------------------------------------
# 엔드포인트 경로 (Kubernetes 표준 따름)
# -----------------------------------------------------------------------------
endpoints:
  # 기본 헬스체크
  health: /health
  
  # Kubernetes 스타일 헬스체크
  healthz: /healthz
  
  # Liveness probe (컨테이너 재시작 판단)
  livez: /livez
  
  # Readiness probe (트래픽 수신 가능 여부)
  readyz: /readyz
  
  # Prometheus 메트릭 (옵션)
  # metrics: /metrics

# -----------------------------------------------------------------------------
# 로깅 설정
# -----------------------------------------------------------------------------
logging:
  # ---------------------------------------------------------------------------
  # 콘솔 로그 (stdout)
  # ---------------------------------------------------------------------------
  console:
    # 콘솔 로그 활성화 여부
    enabled: true
    
    # 콘솔 로그 레벨
    # DEBUG: 모든 로그 출력 (개발/디버깅용)
    # INFO: 정보성 로그 출력 (일반적인 운영)
    # WARN: 경고 이상만 출력 (프로덕션 권장)
    # ERROR: 에러만 출력 (최소 로깅)
    level: INFO
    
    # 콘솔 로그 포맷
    # text: 사람이 읽기 쉬운 형식 (개발 환경)
    # json: 구조화된 JSON 형식 (프로덕션, 로그 분석 도구용)
    format: text
  
  # ---------------------------------------------------------------------------
  # 파일 로그
  # ---------------------------------------------------------------------------
  file:
    # 파일 로그 활성화 여부
    enabled: true
    
    # 파일 로그 레벨
    level: WARN
    
    # 로그 파일 저장 디렉토리
    dir: /opt/healthz/logs
    
    # 로그 파일 이름 패턴
    # {date}: YYYY-MM-DD 형식의 날짜
    # {app}: 애플리케이션 이름
    filename_pattern: "healthz-{date}.log"
    
    # 로그 파일 로테이션 설정
    rotation:
      # 최대 파일 크기 (MB)
      max_size_mb: 10
      
      # 백업 파일 개수 (0이면 덮어쓰기)
      backup_count: 5
      
      # 일별 로테이션 활성화
      daily: true
  
  # ---------------------------------------------------------------------------
  # 기타 로깅 옵션
  # ---------------------------------------------------------------------------
  # 성공한 헬스체크도 로그에 기록할지 (프로덕션: false 권장)
  log_success_checks: false
  
  # 요청/응답 로그 활성화 (디버깅용)
  log_requests: false

# =============================================================================
# 헬스체크 설정
# =============================================================================
checks:
  # ---------------------------------------------------------------------------
  # 포트 체크 (Port Check)
  # 지정된 포트가 리스닝 중인지 확인
  # ---------------------------------------------------------------------------
  ports:
    # 체크 활성화 여부
    enabled: true
    
    # 체크할 포트 목록
    targets:
      - 8080
      # - 18080
      # - 3000
    
    # 체크 조건
    # all: 모든 포트가 리스닝 중이어야 정상
    # any: 하나 이상의 포트가 리스닝 중이면 정상
    condition: all
    
    # 연결 타임아웃 (초)
    timeout: 2

  # ---------------------------------------------------------------------------
  # 프로세스 체크 (Process Check)
  # 지정된 프로세스가 실행 중인지 확인
  # ---------------------------------------------------------------------------
  processes:
    # 체크 활성화 여부
    enabled: true
    
    # 체크할 프로세스 이름 목록
    targets:
      - python
      - gunicorn
      # - celery
      # - nginx
    
    # 체크 조건
    # all: 모든 프로세스가 실행 중이어야 정상
    # any: 하나 이상의 프로세스가 실행 중이면 정상 (권장)
    condition: any
    
    # 프로세스 매칭 타입
    # exact: 정확한 프로세스 이름 매칭
    # partial: 부분 문자열 매칭 (권장)
    match_type: partial

  # ---------------------------------------------------------------------------
  # HTTP API 체크 (HTTP Endpoint Check)
  # 지정된 HTTP 엔드포인트의 응답을 확인
  # ---------------------------------------------------------------------------
  http:
    # 체크 활성화 여부
    enabled: true
    
    # 체크할 엔드포인트 목록
    endpoints:
      # 내부 API 체크
      - name: self_health
        url: http://localhost:8080/health
        method: GET
        timeout: 5
        expected_status: [200, 201, 204]
        expected_body: null  # null이면 상태 코드만 확인
      
      # 외부 서비스 체크 (예시)
      # - name: external_api
      #   url: https://api.example.com/health
      #   method: GET
      #   timeout: 3
      #   expected_status: [200]
      #   headers:
      #     Authorization: Bearer your-token

  # ---------------------------------------------------------------------------
  # 시스템 리소스 체크 (System Resource Check)
  # CPU, 메모리, 디스크 사용률 확인
  # ---------------------------------------------------------------------------
  resources:
    # CPU 체크
    cpu:
      # 체크 활성화 여부 (CPU는 변동성이 커서 기본 비활성화 권장)
      enabled: false
      
      # 사용률 임계값 (%)
      threshold_percent: 90
    
    # 메모리 체크
    memory:
      # 체크 활성화 여부
      enabled: true
      
      # 사용률 임계값 (%)
      threshold_percent: 90
    
    # 디스크 체크
    disk:
      # 체크 활성화 여부
      enabled: true
      
      # 사용률 임계값 (%)
      threshold_percent: 85
      
      # 체크할 경로 목록
      paths:
        - /
        # - /data
        # - /var/log

  # ---------------------------------------------------------------------------
  # 데이터베이스 체크 (Database Check) - 옵션
  # ---------------------------------------------------------------------------
  database:
    # 체크 활성화 여부
    enabled: false
    
    # 데이터베이스 타입
    # postgresql, mysql, mongodb, redis
    type: postgresql
    
    # 연결 정보
    connection:
      # 연결 URL (권장)
      url: postgresql://user:pass@localhost:5432/dbname
      
      # 또는 개별 설정
      # host: localhost
      # port: 5432
      # database: mydb
      # user: myuser
      # password: mypass
    
    # 연결 타임아웃 (초)
    timeout: 5
    
    # 테스트 쿼리 (옵션)
    check_query: SELECT 1

  # ---------------------------------------------------------------------------
  # Redis 체크 (Redis Check) - 옵션
  # ---------------------------------------------------------------------------
  redis:
    # 체크 활성화 여부
    enabled: false
    
    # Redis 연결 정보
    host: localhost
    port: 6379
    db: 0
    password: null
    
    # 연결 타임아웃 (초)
    timeout: 3

# -----------------------------------------------------------------------------
# 타이밍 설정 (Kubernetes/Docker 프로브 설정 참고용)
# 실제 타이밍은 Kubernetes/Docker에서 제어되지만, 여기서 권장값을 정의
# -----------------------------------------------------------------------------
timing:
  # 초기 지연 시간 (초)
  # 컨테이너 시작 후 첫 체크까지 대기하는 시간
  initial_delay_seconds: 15
  
  # 체크 주기 (초)
  # 헬스체크를 수행하는 간격
  period_seconds: 10
  
  # 타임아웃 (초)
  # 헬스체크 응답을 기다리는 최대 시간
  timeout_seconds: 5
  
  # 실패 임계값 (횟수)
  # 연속으로 이 횟수만큼 실패하면 컨테이너를 비정상으로 판단
  failure_threshold: 3
  
  # 성공 임계값 (횟수)
  # 연속으로 이 횟수만큼 성공하면 컨테이너를 정상으로 판단
  success_threshold: 1

# -----------------------------------------------------------------------------
# 프로브별 체크 항목 매핑 (Kubernetes 표준)
# -----------------------------------------------------------------------------
probes:
  # Liveness probe - 컨테이너가 살아있는지 확인 (가벼운 체크)
  # 실패 시 컨테이너 재시작
  liveness:
    checks:
      - ports
      - processes
  
  # Readiness probe - 트래픽을 받을 준비가 되었는지 확인 (전체 체크)
  # 실패 시 로드밸런서에서 제외
  readiness:
    checks:
      - ports
      - processes
      - http
      - resources
      # - database  # 필요시 활성화
  
  # Startup probe - 느린 시작 애플리케이션용 (선택적)
  # 성공할 때까지 liveness/readiness 체크를 지연
  startup:
    checks:
      - ports
      - processes
